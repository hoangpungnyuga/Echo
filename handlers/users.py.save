from loader import bot, dp
import asyncio
import ping3
from aiogram import types
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from data.functions.models import *
from aiogram.types.message_id import MessageId
from aiogram.dispatcher.filters.state import StatesGroup, State
from aiogram.utils.markdown import link

class States(StatesGroup):
	setnick = State()

def get_mention(user):
	return f"t.me/{user.username}" if user.username else f"t.me/None"

@dp.message_handler(state=States.setnick, content_types="text")
async def setnick(message, state):
	if len(message.text) > 16:
		return await message.reply("–ù–µ –º–æ–∂–Ω–∞ –±—ñ–ª—å—à–µ –Ω—ñ–∂ 16 —Å–∏–º–≤–æ–ª—ñ–≤")
	haha = Users.get(Users.id==message.chat.id).name
	Users.update(name=message.text).where(Users.id==message.chat.id).execute()
	await state.finish()
	if haha:
		await message.reply("–ù—ñ–∫ –∑–º—ñ–Ω–µ–Ω–æ")
	else:
		await message.reply("–ù—ñ–∫ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")

@dp.callback_query_handler(text="nick")
async def nick(call: CallbackQuery):
	await call.answer("–¢—ã –≤–∏–¥–∏—à—å —Å—Å—ã–ª–∫—É –Ω–∞ —ç—Ç—É –∫–Ω–æ–ø–∫—É? –ù–µ—Ç? –Ø —Ç–æ–∂–µ –Ω–µ—Ç.\n–í–≤–µ–¥–∏: /nick –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π!", show_alert=True)

@dp.message_handler(commands=["rules"])
async def rules(message: Message):
	keyboard = InlineKeyboardMarkup(row_width=2)
	pinushes = [("–¶–ø", "ban"), ("–†–∞—Å—á–ª–µ–Ω–µ–Ω–∏–µ", "purge"), ("–ñ–æ—Ä—Å—Ç–∫–µ 18+", "purge?"), ("–ó–æ–æ—Ñ—ñ–ª—ñ—è", "purge?"), ("–§–ª—É–¥/–°–ø–∞–º", "–í –º–µ—Ä—É"), ("–†–µ–∫–ª–∞–º–∞", "purge?")]
	for wtf, pinush in pinushes:
		keyboard.add(InlineKeyboardButton(wtf, callback_data="n"), InlineKeyboardButton(pinush, callback_data="n"))
	await message.reply(f"–ü—Ä–∞–≤–∏–ª–∞ —ç—Ç–æ–≥–æ –±–æ—Ç–∞üï≥Ô∏è\n? - –í–æ–∑–º–æ–∂–Ω—ã–π. –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ —á—Ç–æ –≤—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ.:", reply_markup=keyboard)
    
@dp.message_handler(commands=["cmd"])
async def rules(message: Message):
	keyboard = InlineKeyboardMarkup(row_width=2)
	pinushes = [("/start", "–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"), ("/rules", "–ü—Ä–∞–≤–∏–ª–∞"), ("/nick", "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –Ω—ñ–∫–∞"), ("/stats", "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"), ("/admincmd", "–ê–¥–º—ñ–Ω –∫–æ–º–∞–Ω–¥–∏"), ("/ping", "–ü–∏–Ω–≥ TELEGRAM")]
	for wtf, pinush in pinushes:
		keyboard.add(InlineKeyboardButton(wtf, callback_data="n"), InlineKeyboardButton(pinush, callback_data="n"))
	await message.reply("–°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥:", reply_markup=keyboard)

@dp.message_handler(commands=["admincmd"])
async def rules(message: Message):
	keyboard = InlineKeyboardMarkup(row_width=2)
	pinushes = [("/admin", "–ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å"), ("/uid", "ID —é–∑–µ—Ä–∞"), ("/promote", "/demote"), ("/mute", "/unmute"), ("/purge", "–û—á–∏—â–µ–Ω–Ω—è"), ("/ban", "/unban")]
	for wtf, pinush in pinushes:
		keyboard.add(InlineKeyboardButton(wtf, callback_data="n"), InlineKeyboardButton(pinush, callback_data="n"))
	await message.reply("–°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤:", reply_markup=keyboard)

@dp.message_handler(commands=["stats"])
async def stats(message: Message):
	users = Users.select()
	await message.reply(f"üëæ–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Å–µ–π—á–∞—Å <code>{len(users)}</code> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–æ—Ç–µ")

@dp.message_handler(commands=["pleaseunban"])
async def note(message: Message):
    await message.reply(f'–Ø–∫—â–æ –≤–∞—Å –æ–±–º–µ–∂–∏–ª–∏ –±–µ–∑ –ø—Ä–∏—á–∏–Ω/–∑ –ø–æ–º–∏–ª–∫–∏, –ø–∏—à—ñ—Ç—å –∞–¥–º—ñ–Ω–∞–º \n–í–ª–∞—Å–Ω–∏–∫ @HateisEternal \n–ú–æ–¥–µ—Ä @Sunzurai', parse_mode="HTML")

@dp.message_handler(commands=["ban"])
async def note(message: Message):
    await message.reply(f"–û—Ç–∫–∞–∑–∞–Ω–æ.")

@dp.message_handler(commands=["unban"])
async def note(message: Message):
    await message.reply(f"–û—Ç–∫–∞–∑–∞–Ω–æ.")

@dp.message_handler(commands=["help"])
async def help(message: Message):
	await message.reply('–Ø –±—É–¥—É –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ —Ç–≤–æ—ó –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—Å—ñ–º —é–∑–µ—Ä–∞–º.\n/cmd - —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥', parse_mode="HTML")

@dp.message_handler(commands=["profile"])
async def profile(message: Message):
    await message.reply(f'In developing. wait for update', parse_mode="HTML")

@dp.message_handler(commands=['ping'])
async def ping_telegram(message: types.Message):
	dc1 = ping3.ping('149.154.175.53')
	dc2 = ping3.ping('149.154.167.51')
	dc3 = ping3.ping('149.154.175.100')
	dc4 = ping3.ping('149.154.167.91')
	dc5 = ping3.ping('91.108.56.130')
	await message.reply(f'PONG!\nüèì–ü–∏–Ω–≥ —Ç–µ–ª–µ–≥—Ä–∞–º –¥–∞—Ç–∞ —Ü–µ–Ω—Ç—Ä–æ–≤:\n\n\nüá∫üá∏DC1 MIA, Miami FL, USA:<code>{dc1}</code>.ms\n\nüá≥üá±DC2 AMS, Amsterdam, NL:<code>{dc2}</code>.ms\n\nüá∫üá∏DC3* MIA, Miami FL, USA:<code>{dc3}</code>.ms\n\nüá≥üá±DC4 AMS, Amsterdam, NL:<code>{dc4}</code>.ms\n\nüá∏üá¨DC5 SIN, Singapore, SG:<code>{dc5}</code>.ms', parse_mode="HTML")

@dp.callback_query_handler(text="nick:back")
async def back_back(call):
	message = call.message
	keyboard = InlineKeyboardMarkup()
	keyboard.add(InlineKeyboardButton("–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏" if not Users.get(Users.id==message.chat.id).name else "–ó–º—ñ–Ω–∏—Ç–∏", callback_data="nick:setup"), InlineKeyboardButton("–í–∏–¥–∞–ª–∏—Ç–∏", callback_data="nick:del"))
	keyboard.add(
		InlineKeyboardButton("–ü–æ–¥–∏–≤–∏—Ç–∏—Å—è",  callback_data="nick:view"),
		InlineKeyboardButton(
			f'–Æ–∑–µ—Ä {"‚úÖ" if Users.get(Users.id==message.chat.id).tag else "‚ùå"}',
			callback_data="nick:tag"
		))
	await message.edit_text("–ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è –Ω—ñ–∫–æ–º:", reply_markup=keyboard)

@dp.callback_query_handler(text="nick:tag")
async def nick_tag(call: CallbackQuery):
	message = call.message
	if Users.get(Users.id==message.chat.id).tag:
		Users.update(tag=False).where(Users.id==message.chat.id).execute()
	else:
		Users.update(tag=True).where(Users.id==message.chat.id).execute()
	keyboard = InlineKeyboardMarkup()
	keyboard.add(InlineKeyboardButton("–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏" if not Users.get(Users.id==message.chat.id).name else "–ó–º—ñ–Ω–∏—Ç–∏", callback_data="nick:setup"), InlineKeyboardButton("–í–∏–¥–∞–ª–∏—Ç–∏", callback_data="nick:del"))
	keyboard.add(
		InlineKeyboardButton("–ü–æ–¥–∏–≤–∏—Ç–∏—Å—è",  callback_data="nick:view"),
		InlineKeyboardButton(
			f'–Æ–∑–µ—Ä {"‚úÖ" if Users.get(Users.id==message.chat.id).tag else "‚ùå"}',
			callback_data="nick:tag"
		))
	await message.edit_text("–ö–µ—Ä—É–≤–∞–Ω–Ω—è –Ω—ñ–∫–æ–º:", reply_markup=keyboard)
	await call.answer("OK")

@dp.callback_query_handler(text="nick:setup")
async def nicksetup(call):
	await call.message.answer("–í–≤–µ–¥–∏ –Ω—ñ–∫:")
	await States.setnick.set()

@dp.callback_query_handler(text="nick:del")
async def nickdel(call):
	message = call.message
	keyb = InlineKeyboardMarkup().add(InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="nick:back"))

	if not Users.get(Users.id==message.chat.id).name:
		return await message.edit_text("–£ —Ç–µ–±–µ –π –Ω–µ –±—É–ª–æ –Ω—ñ–∫—É", reply_markup=keyb)
	Users.update(name=None).where(Users.id==message.chat.id).execute()
	await message.edit_text("–ù—ñ–∫ –≤–∏–¥–∞–ª–µ–Ω–æ", reply_markup=keyb)

@dp.callback_query_handler(text="nick:view")
async def viewnick(call):
	keyb = InlineKeyboardMarkup().add(InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="nick:back"))

	if Users.get(Users.id==call.message.chat.id).name:
		name = Users.get(Users.id==call.message.chat.id).name
		await call.message.edit_text(f"–¢–≤—ñ–π –Ω—ñ–∫: <code>{name}</code>", reply_markup=keyb)
	else:
		await call.message.edit_text("–£ —Ç–µ–±–µ –Ω–µ–º–∞—î –Ω—ñ–∫—É", reply_markup=keyb)

@dp.message_handler(commands=["nick"])
async def nick(message: Message):
	keyboard = InlineKeyboardMarkup()
	keyboard.add(InlineKeyboardButton("–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏" if not Users.get(Users.id==message.chat.id).name else "–ó–º—ñ–Ω–∏—Ç–∏", callback_data="nick:setup"), InlineKeyboardButton("–í–∏–¥–∞–ª–∏—Ç–∏", callback_data="nick:del"))
	keyboard.add(
		InlineKeyboardButton("–ü–æ–¥–∏–≤–∏—Ç–∏—Å—è",  callback_data="nick:view"),
		InlineKeyboardButton(
			f'–Æ–∑–µ—Ä {"‚úÖ" if Users.get(Users.id==message.chat.id).tag else "‚ùå"}',
			callback_data="nick:tag"
		))
	await message.reply("–ö–µ—Ä—É–≤–∞–Ω–Ω—è –Ω—ñ–∫–æ–º:", reply_markup=keyboard)

@dp.message_handler(commands=["start"])
async def hello(message: Message):
	if not Users.select().where(Users.id==message.chat.id).exists():
		Users.create(id=message.chat.id)
	await message.reply("–Ø –±—É–¥—É –ø–∏—Å–∞—Ç—å —Ç–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Å–µ–º —é–∑–µ—Ä–∞–º Echo")

async def send(message, *args, **kwargs):
	return (await message.copy_to(*args, **kwargs)), args[0]

async def Send(message, keyboard, reply_data):
	result = [{"sender_id": message.chat.id}]
	msgs = await asyncio.gather(*[
		send(message, user.id, reply_markup=keyboard, reply_to_message_id=get_reply_id(reply_data, user.id) if message.reply_to_message else None)
		for user in Users.select(Users.id)
		if user.id != message.chat.id
	], return_exceptions=True)

	for msg_obj in msgs:
		if isinstance(msg_obj, tuple):
			msg, user_id = msg_obj
			if isinstance(msg, MessageId):
				result.append({"chat_id": user_id, "msg_id": msg.message_id})
	else:
		result.append({"chat_id": message.chat.id, "msg_id": message.message_id})
	print(result)
	msgs_db = rdb.get("messages", [])
	msgs_db.append(result)
	rdb.set("messages", msgs_db)

@dp.message_handler(content_types="any")
async def any(message: Message):
	if message.content_type == "pinned_message":
		return
	if datetime.now() < Users.get(Users.id==message.chat.id).mute and not Admins.get_or_none(id=message.chat.id):
		delay = Users.get(Users.id==message.chat.id).mute - datetime.now()
		dur = str(delay).split(".")[0]
		return await message.reply(f"–¢–∏ –≤–∂–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è–≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –ø–æ–≤–µ—Ä–Ω–∏—Å—è —á–µ—Ä–µ–∑ <code>{dur}</code>")
	keyboard = InlineKeyboardMarkup()
	if Users.get(Users.id==message.chat.id).name:
		name = Users.get(Users.id==message.chat.id).name
		if Users.get(Users.id==message.chat.id).tag:
			keyboard.add(InlineKeyboardButton(text=name, url=get_mention(message.chat)))
		else:
			keyboard.add(InlineKeyboardButton(text=name, callback_data="nick"))
	Users.update(mute=datetime.now()).where(Users.id==message.chat.id).execute()
	if message.reply_to_message:
		reply_data = get_reply_data(message.chat.id, message.reply_to_message.message_id)
	if message.text or message.caption:
		if Users.get(Users.id==message.chat.id).last_msg == (message.text or message.caption):
			return await message.reply("–ù–µ –º–æ–∂–Ω–∞ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –æ–¥–Ω–∞–∫–æ–≤–∏–º —Ç–µ–∫—Å—Ç–æ–º")
		Users.update(last_msg=message.text or message.caption).where(Users.id==message.chat.id).execute()
	if is_flood(message.chat.id):
		Users.update(mute=datetime.now() + timedelta(hours=1)).where(Users.id==message.chat.id).execute()
		ims = await message.reply("–≠—Ç–æ —Ñ–ª—É–¥. –¢–µ–±—è –∑–∞–º—É—á–µ–Ω–æ –Ω–∞ <code>1:00:00</code>")
		await bot.pin_chat_message(ims.chat.id, ims.message_id)
		await bot.unpin_chat_message(ims.chat.id, ims.message_id)
		try:
			await bot.send_message(-1001888537506,
				f"#FLOOD\n<b>–Æ–∑–µ—Ä:</b> <a href='{get_mention(message.chat)}'>{message.chat.full_name}</a>"
			)
		except: pass
		return

#------------
#async def echo(message):
#	if not Admins.get_or_none(id=message.chat.id):
#        	return
#	admin_kb = InlineKeyboardMarkup()
#	admin_button = InlineKeyboardButton(text=f"{message.from_user.first_name}", url=get_mention(message.chat))
#	admin_kb.add(admin_button)
#
#-----------
	users = Users.select()
	haha = await message.reply("Send...")
	asyncio.create_task(
		Send(message, keyboard, reply_data if message.reply_to_message else None)
	)
	await haha.edit_text(f"–¢–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ <code>{len(users)}</code> —é–∑–µ—Ä–∞–º Echo")
#	await haha.delete()
